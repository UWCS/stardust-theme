{% import "macros/formatters.html" as formatters %}
{%- import "macros/shortcodes.html" as shortcodes -%}
{% import "macros/rooms.html" as rooms %}
{% import "macros/socials.html" as socials %}

{% macro event_circle(e) %}
<a href="{{ e.permalink }}" class="text-decoration-none event-hover" aria-label="See event {{ e.title }}">
  <div class="event-circle mt-0" style="background-color: {{ formatters::colour(colour=e.extra.colour) }}"
    data-bs-theme="dark">
    {% if e.extra.icon %}<span class="event-icon">{{ shortcodes::icon(icon=e.extra.icon) }}</span> {% endif %}
    <b class="event-title">{{ e.title }}</b>
    <span class="event-extras">
      {{ formatters::event_location(resource=e, icon=false, link=false) }}<br>
      {{ formatters::event_time(e=e) }}
    </span>
  </div>
</a>
{% endmacro %}

{% macro event_info(resource, large, page=true)%}
{% if page %}
<a href="{{resource.permalink}}" class="my-2 text-decoration-none text-white card-hover d-block" {% if
  resource.extra.colour -%} data-event-colour="{{ resource.extra.colour }}" {%- endif -%} {% if resource.taxonomies.tags
  -%} data-event-tags="{{ resource.taxonomies.tags }}" {%- endif -%}>
  {% endif %}
  <div class="card text-body-emphasis" {% if resource.extra.colour -%}
    style="background-color: {{ formatters::colour(colour=resource.extra.colour) }}80 !important" {%- endif -%}>
    <div class="card-body">
      <{%- if large -%}h1{%- else -%}h4{% endif %}
        class="card-title two-line-clamp {% if not large %}d-inline{% endif %}">
        {%- if resource.extra.icon %}{{ shortcodes::icon(icon=resource.extra.icon, baseline=true) }} {% endif -%}
        {%- if resource.extra.emoji %}{{resource.extra.emoji}}{% endif -%}
        <span>{{ resource.title }}</span>
        {%- if resource.extra.emoji %}{{resource.extra.emoji}}{% endif -%}
      </{%- if large -%}h1{%- else -%}h4{%- endif -%}>

      {% if large %}
      {% if resource.taxonomies %}
      {% for tax, terms in resource.taxonomies %}
      {% for term in terms %}
      <a class="badge bg-secondary text-decoration-none ms-1 mb-3" {% set t=get_taxonomy_term(kind=tax, term=term) %}
        href="{{ t.permalink }}" aria-label="View all events tagged with {{ term }}">
        {{ term }}
      </a>
      {% endfor %}
      {% endfor %}
      {% endif %}

      <h4>
        {{ shortcodes::icon(icon="ph-clock") }}
        {{ formatters::event_date_range(e=resource) }}
      </h4>
      <h4>
        {{ formatters::event_location(resource=resource, link=not page) }}
      </h4>
      {% else %}
      <p class="d-inline">
        {{ shortcodes::icon(icon="ph-clock") }}
        {{ formatters::event_time_range(e=resource) }}
        {{ formatters::event_location(resource=resource, link=not page) }}
      </p>
      {% endif %}
    </div>
  </div>
  {% if page %}
</a>
{% endif %}
{% endmacro %}


{% macro day(events,grid=true) %}
{% if events[0].extra.display_day %}
{% set date = events[0].extra.display_day %}
{% else %}
{% set date = events[0].date | date(format="%A") %}
{% endif %}
{% if grid %}
<div class="event-outer" data-event-count="{{ events | length }}">

  {% if date %}
  {# if Wednesday add 0-width space to allow for break as wed #}
  {% if date == "Wednesday"%}
  <h3 class="fw-semibold day-clamp lh-1">Wed​nesday</h3>
  {% else %}
  <h3 class="fw-semibold lh-1">{{ date }}</h3>
  {% endif %}
  {% endif %}

  <div class="day">
    {% else %}
    <h5 class="mb-0">{{date}}</h5>
    {% endif %}

    {% for e in events | sort(attribute="date") %}
    {% if grid %}
    {{ events::event_circle(e=e) }}
    {% else %}
    {{events::event_info(resource=e, large=false)}}
    {% endif %}
    {% endfor %}

    {% if grid %}
  </div>
</div>
{% endif %}
{% endmacro %}

{% macro filler(cols=3) %}
<div class="filler day-{{cols}}-show event-outer bg-body rounded-4 text-center text-white" data-event-count="1">
  <h3 class="fw-semibold">Join Us</h3>
  <ul class="nav list-unstyled d-flex align-items-center">
    {% set socs = get_section(path="socials/_index.md") %}
    {% for social in socs.pages %}
    {% if social.extra.schedule_skip %}{% continue %}{% endif %}
      {{ socials::filler_social(social=social) }}
    {% endfor %}
  </ul>
  <h5 class="mb-0">go.uwcs.uk/links</h5>
</div>
{% endmacro %}


{% macro week(w, title="", grid=true) %}
{# MIRROR ANY CHANGES HERE TO uwcs.ical fetching #}
{# Because Tera is annoying, lists get cast to string when passing through macros, so we have to duplicate #}

{# Fetch each set of events #}
{% set week_events = w.pages | sort(attribute="date") %}

{# Check repeat path is child of term #}
{% set rep_path = w.components[0] ~ "/" ~ w.components[1] ~ "/repeat/_index.md" %}
{% set term = get_section(path=w.ancestors[2], metadata_only=true) %}
{% if term.subsections is containing(rep_path) %}
  {# Get repeating events #}
  {% set repeating = get_section(path=rep_path) %}
  {% set rep_base = repeating.extra.base_date | date(format="%s") | int %}
  {% set all_rep_events = repeating.pages | sort(attribute="date") %}

  {# Filter events by the current week number #}
  {% set week_no = w.components | last | trim_start_matches(pat="w") | int %}
  {% set rep_events = [] %}
  {% for e in all_rep_events %}
    {% if not e.extra.weeks or e.extra.weeks is containing(week_no) %}
      {% set_global rep_events = rep_events | concat(with=e) %}
    {% endif %}
  {% endfor %}
{% else %}
  {% set rep_events = [] %}
{% endif %}

{# Combined list is only needed to iterate over to get correct length (no while loops) #}
{% set events = week_events | concat(with=rep_events) %}

{# Initialize variables for two pointers method #}
{% set week_base = w.extra.base_date | date(format="%s") | int %}
{% set wi = 0 %}
{% set ri = 0 %}

{% set prev_day = "" %}
{% set days_events = [] %}
{# Week formatting preamble #}
<div {% if grid %} class="week w-100 text-center" {% endif %}>
  {% if title %}
    <h2>
      <a class="link-body-emphasis text-decoration-none" href="{{ w.permalink | safe }}"
        aria-label="See events on week {{ title }}">{{ title }}</a>
      <span class="fs-5">(w/b {{ w.extra.base_date | date(format="%d %b") }})</span>
    </h2> 
  {% endif %}
  {% if grid %}
  <div class="events d-grid justify-content-center" data-event-total={{ events | length }}>
  {% endif %}
    {% for ev in events %}
    
      {# Use the two pointers method to iterate over the repeating and week event lists in order #}
      {# Sort by difference between event dates and base_date #}

      {% if wi >= week_events | length %}{% set e = rep_events[ri] %}{% set_global ri = ri + 1 %}     {# Clear out weeks if either list empty #}
      {% elif ri >= rep_events | length %}{% set e = week_events[wi] %}{% set_global wi = wi + 1 %}
      {% else %}
        {% set w_date = week_events[wi].date | date(format="%s") | int %}
        {% set r_date = rep_events[ri].date | date(format="%s") | int %}
        
        {% if w_date - week_base < r_date - rep_base %}
          {% set e = week_events[wi] %}{% set_global wi = wi + 1 %}
        {% else %}
          {% set e = rep_events[ri] %}{% set_global ri = ri + 1 %}
        {% endif %}
      {% endif %}

      {# Store list of events while days are the same, when different, output previous day's events #}
      {% if e.extra.display_day %}
        {% set e_day = e.extra.display_day %}
      {% else %}
        {% set e_day = e.date | date(format="%A") %}
      {% endif %}
      {% if e_day != prev_day %}
        {# Output previous day's content #}
        {% if days_events %}
          {{ events::day(events=days_events, grid=grid) }}
          {% set_global days_events = [] %}
          {% set_global started = true %}
        {% endif %}
        {% set_global prev_day = e_day %}
      {% endif %}
      {% set_global days_events = days_events | concat(with=e) %}
    {% endfor %}

    {# Clean up remaining days_events #}
    {% if days_events %}
      {{ events::day(events=days_events, grid=grid) }}
    {% endif %}
    {% if grid %}
  </div>
  {% endif %}
</div>
{% endmacro %}

{% macro term(t, weeks="", title="", week_no=-1, archive=false, grid=true) %}
{% if not weeks %}
{# MIRROR ANY CHANGES HERE TO uwcs.ical fetching #}
{# Because Tera is annoying, lists get cast to string when passing through macros, so we have to duplicate #}
{% set weeks = [] %}
{% for ss in t.subsections %}
{% set week = get_section(path=ss) %}
{% set_global weeks = weeks | concat(with=week) %}
{% endfor %}
{% set weeks = weeks | sort(attribute="extra.base_date") %}
{% endif %}
{% set added_event = false %}

{% if grid %}
<div class="term blue event-mobile" data-bs-theme="dark">
  {% if title %}<h1><a class="link-body-emphasis text-decoration-none" href="{{ t.permalink | safe }}"
      aria-label="See events in {{ title }}">{{ title }}</a>
  </h1>{% endif %}
  <div class="weeks w-100 {% if archive %}reverse{% endif %}">
    {% endif %}
    {% for week in weeks %}
    {# Compare weeks (ignore past/future) #}
    {% set e_year = week.extra.base_date | date(format="%Y") | int %}
    {% set e_week = week.extra.base_date | date(format="%W") | int %}
    {% set e_week_no = e_week + 54 * e_year %}

    {% if not archive and week_no > 0 %}
      {% if e_week_no < week_no %}{% continue %}{% endif %}
    {% elif week_no > 0 %}
      {% if e_week_no > week_no %}{% continue %}{% endif %}
    {% endif %}

      {% set_global added_event = true %}
      {% if grid %}<div class="my-4">{% endif %}
      {{ events::week(w=week, title=week.title, grid=grid) }}
      {% if grid %}</div>{% endif %}
      {% endfor %}

      {% if not added_event %}
      <h2 class="text-center">No events {% if archive %}finished{% endif %} yet, please check back soon™</h2>
      {% endif %}
      {% if grid %}
  </div>
</div>
{% endif %}
{% endmacro %}

{% macro event_block(resource, grid) %}

{% set now = now() %}
{% set this_year = now | date(format="%Y") | int %}
{% set this_week = now | date(format="%W") | int %}
{% set week_no = this_week + 54 * this_year %}
{% set archive = resource.extra.archive | default(value=false) %}

<div id="events-block" {% if archive %}class="reverse" {% endif %}>
  {# MIRROR ANY CHANGES HERE TO uwcs.ical fetching #}
  {% set events = get_section(path="events/_index.md") %}
  {% for t in events.subsections %}
  {% if t is containing("archive") %}{% continue %}{% endif %}
  {% set term = get_section(path=t) %}
  {{ events::term(t=term, title=term.title, week_no=week_no, archive=archive, grid=grid) }}
  {% endfor %}
</div>

{% endmacro %}

{% macro calendar_script() %}
<script>
  combs = {
    1: [[1, 1]],
    2: [[2, 1], [1, 2]],
    3: [[3, 1], [2, 2], [1, 3]],
    4: [[2, 2]],
    5: [[3, 2], [2, 3]],
    6: [[3, 2], [2, 3]],
  }

  function next_cell(loc, shift = 1) {
    loc[0] += shift;
    if (loc[0] >= cols) {
      loc[0] = 0;
      loc[1] += 1;
    }
  }

  function pack(i, grid, day, loc, cols) {
    if (day.dataset.eventCount > 6) return `day-${cols}-1x${cols}`;
    layouts = combs[day.dataset.eventCount];
    for (var dim of layouts) {
      // console.log(`Trying ${dim}, ${loc}`);
      if (fits(dim, loc, grid, cols)) {
        set_region(i, dim, loc, grid);
        return `day-${cols}-${dim[0]}x${dim[1]}`;
      }
    }
    return undefined;
  }

  function fits(dim, loc, grid, cols) {
    if (loc[0] + dim[0] > cols) return false;

    for (let y = loc[1]; y < loc[1] + dim[1]; y++) {
      if (y >= grid.length) continue;
      for (let x = loc[0]; x < loc[0] + dim[0]; x++) {
        if (grid[y][x] != -1) return false;
      }
    }
    // console.log("Fits");
    return true;
  }

  function set_region(i, dim, loc, grid) {
    // console.log("Filling");
    for (let y = loc[1]; y < loc[1] + dim[1]; y++) {
      if (y >= grid.length) grid.push(Array.from({ length: cols }, () => -1));
      for (let x = loc[0]; x < loc[0] + dim[0]; x++) {

        // console.log("Filling", x, y, i);
        grid[y][x] = i;
      }
    }
    next_cell(loc, dim[0]);
  }

  var week_events = document.getElementsByClassName("events");
  for (var week of week_events) {
    for (var cols of [2, 3]) {
      var grid = Array.from({ length: 3 }, () => Array.from({ length: cols }, () => -1));
      var pos = [0, 0];
      for (const [i, day] of Array.prototype.entries.call(week.children)) {
        if (day.classList.contains("filler")) continue;
        while (true) {
          let p = pack(i, grid, day, pos, cols);
          if (!p) next_cell(pos);
          else {
            day.classList.add(p);
            break
          }
        }
      }
      // Calculate position of filler item
      grid = grid.filter(r => r.some(c => c != -1));
      const flattened = grid.flat();
      const emptyInd = flattened.indexOf(-1);
      if (emptyInd > 0) {
        const prec = flattened[emptyInd - 1];
        week.children[prec].insertAdjacentHTML("afterend", cols == 3 ? `{{ events::filler(cols=3) }}` : `{{ events::filler(cols=2) }}`)
      }
    }
  }
</script>
{% endmacro %}

{% macro filter_controls() %}
<div class="vstack d-none" id="filter-controls">
  <h2>Filter Events</h2>
  <h4  id="category-title" class="d-none">Category</h4>
  <div id="category-filters" class="d-none"></div>
  <h4  id="tag-title" class="d-none mt-2">Tags</h4>
  <div id="tag-filters" class="d-none"></div>
  <hr>
</div>
{% endmacro %}

{% macro filter_script() %}
<script>
  // these 'categories' are actually specified by the 'colour'
  // property, but they fit well enough to categorise events
  // and are probably more useful than the tags
  // taken from colours.json
  const ALLOWED_CATEGORIES = [
      "gaming", "academic", "tech", "social", "inclusivity",
      "milk", "other"
  ];
  const CATEGORY_COLOURS = {
      "academic":   '{{- formatters::colour(colour="academic")    -}}',
      "gaming":     '{{- formatters::colour(colour="gaming")      -}}',
      "social":     '{{- formatters::colour(colour="social")      -}}',
      "tech":       '{{- formatters::colour(colour="tech")        -}}',
      "milk":       '{{- formatters::colour(colour="milk")        -}}',
      "inclusivity":'{{- formatters::colour(colour="inclusivity") -}}',
      "other":      '{{- formatters::colour(colour="secretary")   -}}',
  };
  const CATEGORY_DISPLAY_NAMES = {
      "gaming":     'Gaming',
      "academic":   'Academic',
      "tech":       'Tech',
      "social":     'Social',
      "inclusivity":'Inclusivity',
      "milk":       'Milk',
      "other":      'Other',
  }

  var used_categories = new Set();
  var used_tags = new Set();
  // mapping from a tag to a set of categories that tag appears in
  var tag_categories = new Map();
  function load_single_event_data(elem) {
      let category = elem.getAttribute("data-event-colour") || "";
      if (!ALLOWED_CATEGORIES.includes(category)) {
          category = "other"; // default to 'other' category
          used_categories.add(category);
      } else {
          used_categories.add(category);
      }

      const data_tags = elem.getAttribute("data-event-tags") || "";
      let tags = [];
      // data tags will be empty if no tags provided
      if (data_tags !== "") {
          tags = data_tags.slice(1,-1).split(", ");
          tags.forEach(tag => {
              if (!used_tags.has(tag)) {
                  tag_categories.set(tag, new Set());
              }
              used_tags.add(tag);
              tag_categories.get(tag).add(category);
          });
      }

      return {
          elem: elem,
          category: category,
          tags: tags
      }
  }

  const event_holder = document.getElementById("events-block");

  const event_elms = event_holder.querySelectorAll("a.card-hover");
  const events = Array.from(event_elms).map(load_single_event_data);

  const category_title = document.getElementById("category-title");
  const category_filter_holder = document.getElementById("category-filters");
  const tag_title = document.getElementById("tag-title");
  const tag_filter_holder = document.getElementById("tag-filters");

  // Unhide the filter controls if we have categories or tags to filter by
  if (used_categories.size > 0 || used_tags.size > 0) {
      document.getElementById("filter-controls").classList.remove("d-none");
  }
  if (used_categories.size > 0) {
      category_title.classList.remove("d-none");
      category_filter_holder.classList.remove("d-none");
  }
  if (used_tags.size > 0) {
      tag_title.classList.remove("d-none");
      tag_filter_holder.classList.remove("d-none");
  }

  // Populate the categories control
  for (const cat of Array.from(used_categories).sort()) {
      let e = document.createElement("button");
      e.innerText = CATEGORY_DISPLAY_NAMES[cat];
      e.classList.add("btn");
      e.classList.add("event-tag");
      e.classList.add("m-1");
      e.style.setProperty("--highlight-colour", CATEGORY_COLOURS[cat]);
      e.onclick = () => { toggle_filter_category(cat) };
      
      category_filter_holder.appendChild(e);
  }
  
  // Populate the tags control
  for (const tag of Array.from(used_tags).sort()) {
      let e = document.createElement("button");
      e.innerText = tag;
      e.classList.add("btn");
      e.classList.add("event-tag");
      e.classList.add("m-1");
      e.onclick = () => { toggle_filter_tag(tag) };

      tag_filter_holder.appendChild(e);
  }

  var filter_categories = new Set();
  var selected_tags = new Set();
  var enabled_tags = used_tags;
  function toggle_filter_category(category_name) {
      // update the display
      // clicked one has it's state toggled
      for (const child of category_filter_holder.children) {
          if (child.innerText === CATEGORY_DISPLAY_NAMES[category_name]) {
              if (filter_categories.has(category_name)) {
                  // we are deselecting the category
                  child.classList.remove("event-tag-selected")
                  filter_categories.delete(category_name);
              } else {
                  // select the category
                  child.classList.add("event-tag-selected")
                  filter_categories.add(category_name);
              }
          }
      }

      // hide and deselect tags that don't have any events in this category
      for (const tag of tag_filter_holder.children) {
          if (filter_categories.size === 0 ||
              intersect(tag_categories.get(tag.innerText), filter_categories).size !== 0) {
              // keep showing this tag
              tag.classList.remove("d-none");
              enabled_tags.add(tag.innerText);
          } else {
              // hide this tag
              tag.classList.add("d-none");
              enabled_tags.delete(tag.innerText);
          }
      }
      // hide tag selector if there are no visible tags
      if (enabled_tags.size == 0) {
          tag_title.classList.add("d-none");
          tag_filter_holder.classList.add("d-none");
      } else {
          tag_title.classList.remove("d-none");
          tag_filter_holder.classList.remove("d-none");
      }

      update_event_view()
  }

  function toggle_filter_tag(tag_name) {
      // Toggle the display state of this tag, and add/remove it from the filter
      for (const child of tag_filter_holder.children) {
          if (child.innerText === tag_name) {
              if (selected_tags.has(tag_name)) {
                  // we are deselecting the tag
                  child.classList.remove("event-tag-selected")
                  selected_tags.delete(tag_name);
              } else {
                  // select the tag
                  child.classList.add("event-tag-selected")
                  selected_tags.add(tag_name);
              }
              break;
          }
      }

      update_event_view()
  }

  function update_event_view() {
      let filter_tags = intersect(enabled_tags, selected_tags);
      // hide/show the individual events
      for (const event of events) {
          let hide_cat = false;
          if (filter_categories.size !== 0 && !filter_categories.has(event.category)) {
              hide_cat = true;
          }

          // Don't hide for tags if there are no selected tags
          let hide_tag = filter_tags.size > 0;
          for (const event_tag of event.tags) {
              if (filter_tags.has(event_tag)) {
                  hide_tag = false;
                  break;
              }
          }

          if (hide_cat || hide_tag) {
              event.elem.classList.remove("d-block");
              event.elem.classList.add("d-none");
          } else {
              event.elem.classList.remove("d-none");
              event.elem.classList.add("d-block");
          }
      }

      // hide/show the day of the week headings
      for (const day_name of event_holder.querySelectorAll("h5")) {
          let sib = day_name;
          while (true) {
              sib = sib.nextElementSibling;
              if (sib === null || sib.tagName === "H5") {
                  // found (next day)/(end of week) and no events, so hide this day
                  day_name.classList.add("d-none");
                  break;
              } else if (sib.tagName === "A" && sib.classList.contains("d-block")) {
                  // found an event for this day, so show this day
                  day_name.classList.remove("d-none");
                  break;
              }
          }
      }

      // hide/show the week headings
      for (const week_name of event_holder.querySelectorAll("h2")) {
          week_name.classList.remove("d-none");
          let parent = week_name.parentElement;
          if (parent.childElementCount === 1+parent.querySelectorAll(".d-none").length) {
              // all elements other than the heading are hidden
              // so no visible events, so hide heading
              week_name.classList.add("d-none");
          }
      }
  }

  // set intersection, unfortunately the default js
  // set intersection operation is not widely supported
  function intersect(a, b) {
      let res = new Set();
      for (const val of a) {
          if (b.has(val)) {
              res.add(val)
          }
      }
      return res;
  }
</script>
{% endmacro %}